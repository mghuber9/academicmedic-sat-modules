<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Review — Missed Questions</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f0f0f0}
    .topbar{background:#1e40af;color:#fff;padding:12px 16px;font-weight:bold;display:flex;justify-content:space-between;align-items:center}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:14px;margin:12px 0}
    .muted{color:#6b7280}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    .bad{background:#fee2e2;color:#991b1b}
    .ok{background:#dcfce7;color:#166534}
    .btn{background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:10px 12px;cursor:pointer}
    .btn2{background:#e5e7eb;color:#111827;border:none;border-radius:6px;padding:10px 12px;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    img{max-width:100%;height:auto;display:block;margin:10px 0}
    .ans{margin-top:8px}
    .ans strong{display:inline-block;width:140px}
    code{background:#f3f4f6;padding:2px 6px;border-radius:4px}
    .original-answer .orig-text{
  font-size: 1.1em;
  font-weight: 600;
  color: #7f1d1d; /* dark red */
}
     .original-answer{
  display: flex;
  align-items: center;
  gap: 6px;
}

.original-answer strong{
  width: auto;          /* override the 140px rule */
}

.original-answer .inline{
  display: inline;
}


    

  </style>
</head>
<body>
<div class="topbar">
  <div>
    Review
    <span id="modeBadge" class="pill">Mode</span>
  </div>

  <div class="row">
    <button class="btn2" onclick="setMode('rework')">Rework mode</button>
    <button class="btn2" onclick="setMode('reveal')">Reveal mode</button>

    <button class="btn2" onclick="window.location.href='index.html'">Back to test</button>
    <button class="btn2" onclick="clearAttempt()">Clear saved attempt</button>
  </div>
</div>


  <div class="wrap">
    <div id="summary" class="card"></div>
    <div id="list"></div>
  </div>

<script>
  // ===== Review Mode State =====
// rework: show original answer crossed out + allow rework input (NO correct answers)
// reveal: show correct answers + explanations (we'll implement display in later steps)
let REVIEW_MODE = 'rework';

function setMode(mode){
  REVIEW_MODE = (mode === 'reveal') ? 'reveal' : 'rework';
  updateModeBadge();

  // Only re-render if the function exists and we have loaded questions
  if (
    typeof renderMissedList === 'function' &&
    Array.isArray(window.__AM_questions) &&
    window.__AM_questions.length
  ) {
    renderMissedList(window.__AM_questions, window.__AM_answers);
  }
}



  // Re-render using existing attempt data (we’ll wire the full re-render in Step 4C/4D)
  // For now, this just updates the badge so we know mode switching works.


function updateModeBadge(){
  const badge = document.getElementById('modeBadge');
  if (!badge) return;
  if (REVIEW_MODE === 'reveal'){
    badge.textContent = 'Reveal';
    badge.className = 'pill ok';
  } else {
    badge.textContent = 'Rework';
    badge.className = 'pill bad';
  }
}

// ===== Rework Storage (Step 4B) =====
let ATTEMPT_KEY = null;          // set after loading attempt
let REWORK_STATE = {
  attemptKey: null,
  reworkAnswers: null,           // array same length as questions
  reworkSubmitted: false,
  savedAt: null
};

function getReworkStorageKey(){
  return 'am_last_attempt_rework';
}

function loadReworkState(){
  const raw = localStorage.getItem(getReworkStorageKey());
  if (!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}

function saveReworkState(){
  try{
    REWORK_STATE.savedAt = new Date().toISOString();
    localStorage.setItem(getReworkStorageKey(), JSON.stringify(REWORK_STATE));
  }catch(e){
    console.warn('Could not save rework state:', e);
  }
}

function initReworkForAttempt(questionsLength){
  const existing = loadReworkState();

  if (!existing || existing.attemptKey !== ATTEMPT_KEY){
    REWORK_STATE = {
      attemptKey: ATTEMPT_KEY,
      reworkAnswers: new Array(questionsLength).fill(null),
      reworkSubmitted: false,
      savedAt: new Date().toISOString()
    };
    saveReworkState();
    return;
  }

  REWORK_STATE = existing;

  if (!Array.isArray(REWORK_STATE.reworkAnswers)){
    REWORK_STATE.reworkAnswers = new Array(questionsLength).fill(null);
  } else if (REWORK_STATE.reworkAnswers.length !== questionsLength){
    const arr = new Array(questionsLength).fill(null);
    for (let i = 0; i < Math.min(questionsLength, REWORK_STATE.reworkAnswers.length); i++){
      arr[i] = REWORK_STATE.reworkAnswers[i];
    }
    REWORK_STATE.reworkAnswers = arr;
  }

  saveReworkState();
}


  
  function parseAnswer(answer) {
    if (answer === null || answer === undefined) return NaN;
    answer = String(answer).trim();
    if (!answer) return NaN;
    if (answer.includes('/')) {
      const parts = answer.split('/');
      if (parts.length === 2) {
        const numerator = parseFloat(parts[0]);
        const denominator = parseFloat(parts[1]);
        if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
          return numerator / denominator;
        }
      }
    }
    return parseFloat(answer);
  }

  // Mirrors your index.html correctness logic as closely as possible
  function isCorrectAnswer(q, studentRaw) {
    if (studentRaw === null || studentRaw === undefined) return false;

    if (q.type === "multiple") {
      return String(studentRaw).trim() === String(q.correct).trim();
    }

    if (q.type === "spr") {
      // if correct includes comma, your scorer uses exact string match
      if (String(q.correct).includes(',')) {
        return String(studentRaw).trim() === String(q.correct).trim();
      }
      const userAnswer = parseAnswer(studentRaw);
      const correctAnswer = parseAnswer(q.correct);
      return !isNaN(userAnswer) && !isNaN(correctAnswer) && Math.abs(userAnswer - correctAnswer) < 0.0001;
    }

    // unknown types treated as incorrect
    return false;
  }

  function loadAttempt() {
    const raw = localStorage.getItem('am_last_attempt');
    if (!raw) return null;
    try { return JSON.parse(raw); } catch(e) { return null; }
  }

  async function getQuestionsFromAttempt(attempt) {
    // Prefer the saved questions (fastest). If missing, fetch using modulePath.
    if (Array.isArray(attempt.questions) && attempt.questions.length) return attempt.questions;

    if (attempt.modulePath) {
      const res = await fetch(attempt.modulePath, { cache: "no-store" });
      if (!res.ok) throw new Error("Could not load module JSON: " + res.status);
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error("Module JSON must be an array.");
      return data;
    }

    throw new Error("No questions found and no modulePath to fetch.");
  }

  function renderSummary({total, missedCount, savedAt, modulePath}) {
    const el = document.getElementById('summary');
    el.innerHTML = `
      <div><strong>Missed:</strong> ${missedCount} / ${total}</div>
      <div class="muted" style="margin-top:6px;">
        <div><strong>Saved:</strong> ${savedAt ? new Date(savedAt).toLocaleString() : 'Unknown'}</div>
        <div><strong>Module:</strong> ${modulePath ? `<code>${modulePath}</code>` : 'Unknown'}</div>
      </div>
      <div class="muted" style="margin-top:10px;">
        Note: “Missed” includes incorrect <em>and</em> unanswered questions.
      </div>
    `;
  }

  function renderMissedList(questions, answers) {
    const list = document.getElementById('list');
    list.innerHTML = "";

    let missed = [];

    for (let i = 0; i < questions.length; i++) {
      const q = questions[i];
      const a = (Array.isArray(answers) ? answers[i] : answers?.[i]) ?? null;

      const correct = isCorrectAnswer(q, a);
      if (!correct) {
        missed.push({ index: i, q, a });
      }
    }

    if (missed.length === 0) {
      list.innerHTML = `<div class="card"><span class="pill ok">All correct</span> Nothing to review.</div>`;
      return { missedCount: 0 };
    }

    for (const item of missed) {
      const { index, q, a } = item;
      const studentDisplay = (a === null || a === undefined || String(a).trim() === "") ? "(No answer)" : String(a);
      const correctDisplay = (q.correct === null || q.correct === undefined) ? "(No key)" : String(q.correct);

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div>
            <strong>Question ${index + 1}</strong>
            <span class="pill bad">Missed</span>
          </div>
          <div class="muted">${q.domain ? q.domain : ''}${q.skill ? ' • ' + q.skill : ''}${q.difficulty ? ' • ' + q.difficulty : ''}</div>
        </div>

        ${q.promptImage ? `<img src="${q.promptImage}" alt="Question ${index + 1}">` : ''}

        <div class="ans original-answer">
  <strong>❌ Original answer:</strong>
  <code class="orig-text inline">${escapeHtml(studentDisplay)}</code>
</div>



${REVIEW_MODE === 'reveal' ? `
  <div class="ans"><strong>Correct answer:</strong> <code>${escapeHtml(correctDisplay)}</code></div>
` : `
  <div class="ans muted"><strong>Correct answer:</strong> (hidden in Rework mode)</div>
`}

      `;
      list.appendChild(card);
    }

    return { missedCount: missed.length };
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function clearAttempt() {
    localStorage.removeItem('am_last_attempt');
    document.getElementById('summary').innerHTML = `<div><strong>Saved attempt cleared.</strong></div>`;
    document.getElementById('list').innerHTML = "";
  }

  // make button work
  window.clearAttempt = clearAttempt;

  (async () => {
    updateModeBadge();
    const attempt = loadAttempt();
    if (!attempt) {
      document.getElementById('summary').innerHTML = `
        <div><strong>No saved attempt found.</strong></div>
        <div class="muted" style="margin-top:6px;">Go back, take the test, and submit to create one.</div>
      `;
      return;
    }

    try {
const questions = await getQuestionsFromAttempt(attempt);

ATTEMPT_KEY = `${attempt.savedAt || ''}|${attempt.modulePath || ''}`;
initReworkForAttempt(questions.length);

const answers = attempt.answers;

// ✅ Store globally BEFORE first render
window.__AM_questions = questions;
window.__AM_answers = answers;

// ✅ First render
const { missedCount } = renderMissedList(questions, answers);

renderSummary({
  total: questions.length,
  missedCount,
  savedAt: attempt.savedAt,
  modulePath: attempt.modulePath
});

    } catch (err) {
      document.getElementById('summary').innerHTML = `
        <div><strong>Could not load review.</strong></div>
        <div class="muted" style="margin-top:6px;">${escapeHtml(err.message || String(err))}</div>
      `;
    }
  })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Math Module 2 Grader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        .content-wrapper {
            display: flex;
            height: calc(100vh - 4rem);
        }
        .text-panel {
            width: 20%;
            border-right: 1px solid #ccc;
            padding: 1rem;
            overflow-y: auto;
            background-color: #fff;
        }
        .question-panel {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #fff;
        }
        .timer {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .question-option {
            margin-bottom: 0.5rem;
        }
        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f0f0f0;
            padding: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .incorrect { color: red; font-weight: bold; }
        .correct { color: green; font-weight: bold; }
        .not-marked { color: orange; font-weight: bold; }
        .student-response { margin-top: 0.5rem; }
        .score-display { font-size: 1.5rem; font-weight: bold; margin-top: 1rem; text-align: center; }
        .bg-blue-800 { background-color: #1e40af; }
        .bg-blue-900 { background-color: #1e3a8a; }
        .text-white { color: #fff; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .rounded { border-radius: 0.25rem; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-blue-500 { background-color: #3b82f6; }
        .mr-2 { margin-right: 0.5rem; }
        .ml-2 { margin-left: 0.5rem; }
        .text-lg { font-size: 1.125rem; }
        .font-semibold { font-weight: 600; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .text-center { text-align: center; }
    
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
}
.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 5px;
    max-width: 80%;
    max-height: 80%;
    overflow: auto;
    position: relative;
}
.modal-content img {
    width: 100%;
    height: auto;
}
.close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    cursor: pointer;
    color: #333;
}
.question-link {
    display: block;
    margin-bottom: 0.5rem;
    text-decoration: underline;
    cursor: pointer;
}
.incorrect { color: red; font-weight: bold; }
.correct { color: green; font-weight: bold; }
.not-marked { color: orange; font-weight: bold; }
</style>
</head>
<body>
    <div class="relative">
        <div class="bg-blue-800 text-white p-2 flex justify-between items-center">
            <span>SAT 2 Math Module 1</span>
            <span id="timeDisplay">0:00</span>
        </div>
        <div class="bg-blue-900 text-white p-2 text-center">SAT 2 Math Module 1</div>
    </div>

    <div class="content-wrapper">
        <div class="text-panel" id="textPanel"></div>
        <div class="question-panel" id="questionPanel">
            <div class="flex justify-between items-center mb-4">

<button class="bg-gray-200 px-2 py-1 rounded" onclick="openModal()">Reference</button>

                <button class="bg-gray-200 px-2 py-1 rounded" id="markForReview" onclick="markForReview()">Mark for Review</button>
                <span class="text-lg font-semibold" id="questionNumber"></span>
            </div>
            <div id="questionOptions"></div>
            <div id="result" class="mt-4"></div>
            <div id="questionProgress" class="text-center mt-2"></div>
        </div>
    </div>
    <div class="navigation">
        <span>Student Name</span>
        <div class="flex items-center">
            <button class="bg-blue-500 text-white px-4 py-2 rounded mr-2" onclick="prevQuestion()">Back</button>
            <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="nextQuestion()">Next</button>
            <button class="bg-blue-500 text-white px-4 py-2 rounded ml-2" onclick="submitTest()">Submit Test</button>
        </div>
    </div>

    <script>
        let questions = [];
let currentQuestionIndex = -1;
        let answers = new Array(questions.length).fill(null);
        let reviewedQuestions = new Array(questions.length).fill(false);
        let isTestSubmitted = false;
        let finalScore = '';

        // ===== Module loading (GitHub Pages friendly) =====
        // Put your module JSON at: /modules/module_demo_22.json
        const MODULE_URL = "modules/module_demo_22.json";

        async function loadModuleQuestions() {
            const res = await fetch(MODULE_URL, { cache: "no-store" });
            if (!res.ok) throw new Error("Could not load module JSON: " + res.status);
            const data = await res.json();
            if (!Array.isArray(data)) throw new Error("Module JSON must be an array of questions.");
            questions = data;
            answers = new Array(questions.length).fill(null);
            reviewedQuestions = new Array(questions.length).fill(false);
        }
function parseAnswer(answer) {
            if (!answer) return NaN;
            answer = answer.trim();
            if (answer.includes('/')) {
                const [numerator, denominator] = answer.split('/').map(num => parseFloat(num));
                if (denominator && !isNaN(numerator) && !isNaN(denominator)) {
                    return (numerator / denominator);
                }
            }
            return parseFloat(answer);
        }

        function displayQuestion(index) {
            currentQuestionIndex = index;
            const q = questions[index];
            const questionOptions = document.querySelector('#questionOptions');
            const questionNumber = document.querySelector('#questionNumber');
            const questionProgress = document.querySelector('#questionProgress');
            const result = document.querySelector('#result');

            questionNumber.textContent = q ? `Question ${index + 1}` : '';
questionProgress.textContent = q ? `Question ${index + 1} of ${questions.length}` : '';


            if (isTestSubmitted) {
                result.innerHTML = finalScore;
            } else {
                result.innerHTML = '';
            }

            if (!q) {
                questionOptions.innerHTML = '<p>Please select a question from the left panel to begin.</p>';
                return;
            }

            if (q.type === "multiple") {
                let optionsList = (Array.isArray(q.options) && q.options.length)
  ? q.options
  : ["A) A", "B) B", "C) C", "D) D"];

let optionsHtml = optionsList.map((opt, i) => `
    <div class="question-option">
        <input
    type="radio"
    name="q${index}"
    value="${opt.charAt(0)}"
    id="opt${index}_${i}"
    ${answers[index] === opt.charAt(0) ? 'checked' : ''}
    onchange="saveAnswer(${index}, this.value)"
>

        <label for="opt${index}_${i}" class="ml-2">${opt}</label>

    </div>
`).join('');

                let questionHtml = `
                    <h2 class="text-lg font-semibold">Question ${index + 1}</h2>
                    <p>${(q.text||'').replace(/\n\n/g, '</p><p>')}</p>
                    ${q.promptImage ? `<img src="${q.promptImage}" alt="Question ${index + 1}" style="max-width:100%;height:auto;display:block;margin:12px 0;">` : ''}
                `;
                // Add image placeholder for questions with images
                questionHtml += `${optionsHtml}`;
                questionOptions.innerHTML = questionHtml;
            } else if (q.type === "spr") {
                questionOptions.innerHTML = `
                    <h2 class="text-lg font-semibold">Question ${index + 1}</h2>
                    <p>${(q.text||'').replace(/\n\n/g, '</p><p>')}</p>
                    ${q.promptImage ? `<img src="${q.promptImage}" alt="Question ${index + 1}" style="max-width:100%;height:auto;display:block;margin:12px 0;">` : ''}
                    <div class="student-response">
                        <input type="text" id="sprInput" value="${answers[i] || ''}" placeholder="Enter your answer" oninput="saveAnswer(${index}, this.value)">
                    </div>
                `;
            }
        }

        function updateQuestionList() {
            const textPanel = document.querySelector('#textPanel');
            let html = '<h2>Questions</h2>';
            for (let i = 0; i < questions.length; i++) {
                const q = questions[i];
                let className = 'question-link';
                let status = '';
                if (isTestSubmitted && answers[i] !== null) {
                    const userAnswer = parseAnswer(answers[i]);
                    const correctAnswer = parseAnswer(q.correct);
                    const isCorrect = q.type === "multiple" ? answers[i].toString().trim() === q.correct.toString().trim() : (q.type === "spr" && q.correct.includes(',')) ? answers[i].toString().trim() === q.correct.toString().trim() : !isNaN(userAnswer) && !isNaN(correctAnswer) && Math.abs(userAnswer - correctAnswer) < 0.0001;
                    if (isCorrect) {
                        status = '(Correct)';
                        className += ' correct';
                    } else if (reviewedQuestions[i]) {
                        status = '(Not Marked)';
                        className += ' not-marked';
                    } else {
                        status = '(Incorrect)';
                        className += ' incorrect';
                    }
                } else if (!isTestSubmitted && reviewedQuestions[i]) {
                    status = '(Marked for Review)';
                    className += ' not-marked';
                }
                html += `<div class="${className}" onclick="goToQuestion(${i})">
  Question ${i + 1} ${status}
</div>`;

            }
            textPanel.innerHTML = html;
        }

        function saveAnswer(index, value) {
            answers[i] = value;
            updateQuestionList();
        }

        function goToQuestion(index) {
            displayQuestion(index);
            if (isTestSubmitted && answers[i] !== null) {
                const q = questions[index];
                const userAnswer = parseAnswer(answers[i]);
                const correctAnswer = parseAnswer(q.correct);
                const isCorrect = q.type === "multiple" ? answers[i].toString().trim() === q.correct.toString().trim() : (q.type === "spr" && q.correct.includes(',')) ? answers[i].toString().trim() === q.correct.toString().trim() : !isNaN(userAnswer) && !isNaN(correctAnswer) && Math.abs(userAnswer - correctAnswer) < 0.0001;
                if (!isCorrect) {
                    reviewedQuestions[index] = true;
                    updateQuestionList();
                }
            }
        }

        function markForReview() {
            if (currentQuestionIndex >= 0 && !isTestSubmitted) {
                reviewedQuestions[currentQuestionIndex] = !reviewedQuestions[currentQuestionIndex];
                updateQuestionList();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1 && currentQuestionIndex >= 0) {
                goToQuestion(currentQuestionIndex + 1);
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                goToQuestion(currentQuestionIndex - 1);
            }
        }

        function submitTest() {
            if (isTestSubmitted) return;
            let correctCount = 0;
            for (let i = 0; i < questions.length; i++) {
                if (answers[i] !== null) {
                    const q = questions[i];
                    const userAnswer = parseAnswer(answers[i]);
                    const correctAnswer = parseAnswer(q.correct);
                    const isCorrect = q.type === "multiple" ? answers[i].toString().trim() === q.correct.toString().trim() : (q.type === "spr" && q.correct.includes(',')) ? answers[i].toString().trim() === q.correct.toString().trim() : !isNaN(userAnswer) && !isNaN(correctAnswer) && Math.abs(userAnswer - correctAnswer) < 0.0001;
                    if (isCorrect) correctCount++;
                }
            }
            finalScore = `
  <div class="score-display">
    Total Score: ${correctCount} out of ${questions.length}
  </div>

  <div class="text-center mt-4">
    <button class="bg-blue-500 text-white px-4 py-2 rounded"
      onclick="window.location.href='review.html'">
      Review missed questions
    </button>
  </div>
`;


// ===== SAVE ATTEMPT FOR review.html =====
try {
  const attempt = {
    savedAt: new Date().toISOString(),
    modulePath: MODULE_URL,
    questions: questions,
    answers: answers,
    score: correctCount,
    total: questions.length
  };

  localStorage.setItem('am_last_attempt', JSON.stringify(attempt));
} catch (e) {
  console.warn('Could not save attempt:', e);
}

            
            const result = document.querySelector('#result');
            result.innerHTML = finalScore;
            isTestSubmitted = true;
            updateQuestionList();
            document.querySelectorAll('input[type="radio"], input[type="text"]').forEach(el => el.disabled = true);
            document.querySelector('#markForReview').disabled = true;
            document.querySelectorAll('button:not([onclick="openModal()"], [onclick="closeReferenceModal()"])').forEach(btn => btn.disabled = true);
        }

        let timeLeft = 1500; // 25 minutes in seconds
        const timerDisplay = document.querySelector('#timeDisplay');

        function startTimer() {
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitTest();
                } else {
                    timeLeft--;
                }
            }, 1000);
        }

        // Debug: Check if script runs
        console.log("Script loaded, initializing...");
        console.log("Script loaded, initializing...");
(async () => {
  try {
    await loadModuleQuestions();
    updateQuestionList();
    displayQuestion(0);
    startTimer();
  } catch (err) {
    console.error(err);
    document.querySelector('#questionOptions').innerHTML = `
      <p style="color:#b91c1c;font-weight:bold;">Could not load module file.</p>
      <p>${err.message}</p>
      <p>Expected at: <code>${MODULE_URL}</code></p>
    `;
  }
})();

    
function openModal() {
    document.getElementById('referenceModal').style.display = 'flex';
}
function closeReferenceModal() {
    document.getElementById('referenceModal').style.display = 'none';
}
window.onclick = function(event) {
    const modal = document.getElementById('referenceModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}

</script>

<div id="referenceModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeReferenceModal()">Ã—</span>
        <img src="https://i.imgur.com/IMAGE_ID.jpg" alt="Reference Image">
    </div>
</div>

</body>
</html>
